<div class="post-form-container">
    <%= form_with model: post, local: true do |f| %>
    <div class="image-section" data-controller="image-preview">
        <div class="image-card">
            <div class="image-placeholder" data-image-preview-target="placeholder" style="<%= 'display:none;' if post.image.attached? %>">
            <span class="image-icon">画像なし</span>
            </div>

            <% if post.image.attached? %>
                <img data-image-preview-target="preview"
                    src="<%= url_for(post.image) %>"
                    alt="preview"
                    style="max-width:100%; height:auto; border-radius:12px;" />
            <% else %>
                <img data-image-preview-target="preview"
                    alt="preview"
                    style="display:none; max-width:100%; height:auto; border-radius:12px;" />
            <% end %>
        </div>

        <br>
        <br>
        <div class="slider-row">
            <span class="icon-dim">1</span>
            <%= f.range_field :brightness_level, min: 0, max: 100, value: @post.brightness_level || 50, class: "brightness-input" %>
            <span class="icon-bright">100</span>
        </div>

        <div class="upload-actions">
            <label class="upload-button">
            画像アップロード
            <%= f.file_field :image,
                accept: "image/*",
                class: "hidden-file-input",
                data: { image_preview_target: "input", action: "change->image-preview#show" } %>
            </label>
        </div>
    </div>

    <div class="title-section">
        <label class="title-label">タイトル</label>
        <%= f.text_field :title, class: "title-textarea" %>
    </div>


    <div class="body-section">
        <label class="body-label">投稿内容</label>
        <%= f.text_area :body, rows: 10, class: "body-textarea" %>
    </div>

    <div class="tags-area">
        <div data-controller="tags" class="tags-section">
            <label class="tags-label">タグ(カンマ区切りで追加、Enterでも可)</label>
            <input type="text"
                class="tags-text"
                placeholder="例: カジュアル, 夏, 白"
                data-tags-target="input"
                data-action="keydown->tags#handleKeydown" />
            <button type="button" class="tags-add-button" data-action="click->tags#add">追加</button>

            <div class="tags-preview" data-tags-target="list"></div>

            <%= hidden_field_tag 'post[tag_names]',
                (params.dig(:post, :tag_names).presence || post.tags.pluck(:name).join(", ")),
                data: { tags_target: 'hidden' } %>
        </div>
    </div>

    <div class="category-area">
        <div class="category-header">
            <span class="category-title">カテゴリ</span>
        </div>
        <div class="category-list">
            <%= f.collection_check_boxes :category_ids, categories, :id, :name do |b| %>
                <label class="category-chip">
                    <%= b.check_box class: "category-checkbox" %>
                    <span class="category-pill"><%= b.text %></span>
                </label>
            <% end %>
        </div>
    </div>

    <div class="category-area">
        <div class="category-header">
            <span class="category-title">骨格</span>
        </div>
        <div class="category-list">
            <% User.style_categories.each_key do |key| %>
                <label class="category-chip">
                    <%= f.radio_button :style_category, key, class: "category-checkbox" %>
                    <span class="category-pill">
                        <%= enum_display_name(@post, :style_category, key) %>
                    </span>
                </label>
            <% end %>
        </div>
    </div>

    <div class="category-area">
        <div class="category-header">
            <span class="category-title">身長</span>
        </div>
        <div class="category-list">
            <% User.height_ranges.each_key do |key| %>
                <label class="category-chip">
                    <%= f.radio_button :height_range, key, class: "category-checkbox" %>
                    <span class="category-pill">
                        <%= enum_display_name(@post, :height_range, key) %>
                    </span>
                </label>
            <% end %>
        </div>
    </div>

    <div class="form-actions">
        <%= f.submit (defined?(submit_label) && submit_label.presence) || (post.persisted? ? "更新する" : "投稿"), class: "primary-button" %>
    </div>
    <% end %>
</div>
